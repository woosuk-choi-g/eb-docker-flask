name: deploy to eb
on: 
  workflow_dispatch:
    inputs:
      ECR_REPOSITORY:
        description: ECR 레포지토리
        type: choice
        options:
          - eb-docker-flask
        required: false
      IMAGE_TAG:
        description: 도커 이미지 태그
        type: string
        required: true
run-name: build and push ${{ inputs.ECR_REPOSITORY }}:${{ inputs.IMAGE_TAG }}
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - 
        name: 체크아웃
        uses: actions/checkout@v3
      - 
        name: AWS 로그인
        uses: aws-actions/configure-aws-credentials@v1-node16
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
      - 
        name: ECR 로그인
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      -
        name: 도커 buildx 세팅
        uses: docker/setup-buildx-action@v2
      -
        name: 도커 이미지 빌드하고 푸시
        uses: docker/build-push-action@v3
        with:
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ inputs.ECR_REPOSITORY }}:${{ inputs.IMAGE_TAG }}
          # type=gha 는 실험적인 기능임 ( https://github.com/moby/buildkit#github-actions-cache-experimental )
          cache-from: type=gha
          cahce-to: type=gha,mode=max
          # ECR 은 cache export 를 지원하지않음 ( https://github.com/aws/containers-roadmap/issues/876 )
          # cache-from: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ inputs.ECR_REPOSITORY }}:buildcache
          # cache-to: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ inputs.ECR_REPOSITORY }}:buildcache,mode=max
      -
        name: 도커 latest 이미지 푸시
        uses: docker/build-push-action@v3
        with:
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ inputs.ECR_REPOSITORY }}:latest
  # eb-deploy:
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: ${{ needs.success() }}
      # eb deploy package 빌드
      # eb 배포